<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.demosys.domain.admissions.mapper.PublicAdmissionsOfferMapper">

    <select id="query"
            resultType="com.example.demosys.domain.admissions.mapper.PublicAdmissionsOfferMapper$PublicOfferRow">
        <choose>
            <!-- 1) keyword 为空：默认返回“全部已公示” -->
            <when test="keyword == null or keyword == ''">
                SELECT
                c.name    AS name,
                c.exam_no AS examNo,
                '已公示'  AS offerStatus
                FROM admissions_candidate c
                INNER JOIN admissions_offer_publication p
                ON p.candidate_id = c.id
                ORDER BY p.id DESC
                LIMIT 50
            </when>

            <!-- 2) keyword 非空：按考号精确 / 姓名模糊 查询（已公示/未公示都可返回） -->
            <otherwise>
                SELECT
                c.name    AS name,
                c.exam_no AS examNo,
                CASE WHEN p.candidate_id IS NULL THEN '未公示' ELSE '已公示' END AS offerStatus
                FROM admissions_candidate c
                LEFT JOIN admissions_offer_publication p
                ON p.candidate_id = c.id
                WHERE (c.exam_no = #{keyword}
                OR c.name LIKE CONCAT('%', #{keyword}, '%'))
                ORDER BY c.id DESC
                LIMIT 20
            </otherwise>
        </choose>
    </select>
</mapper>
